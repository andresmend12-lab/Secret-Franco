rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================
    
    // Verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Obtener el UID del usuario actual
    function userId() {
      return request.auth.uid;
    }
    
    // Verificar si el usuario es el host de la partida
    function isHost(gameId) {
      return get(/databases/$(database)/documents/games/$(gameId)).data.hostId == userId();
    }
    
    // Verificar si el usuario es jugador de la partida
    function isPlayerInGame(gameId) {
      return exists(/databases/$(database)/documents/games/$(gameId)/players/$(userId()));
    }
    
    // Verificar si la partida está en estado específico
    function gameStatus(gameId, status) {
      return get(/databases/$(database)/documents/games/$(gameId)).data.status == status;
    }
    
    // ============================================
    // COLECCIÓN: games
    // ============================================
    match /games/{gameId} {
      // Cualquier usuario autenticado puede leer partidas (para buscar por código)
      allow read: if isAuthenticated();
      
      // Solo Cloud Functions pueden crear/modificar partidas
      // Los clientes NUNCA modifican directamente el estado del juego
      allow create: if false; // Solo via Cloud Functions
      allow update: if false; // Solo via Cloud Functions
      allow delete: if false; // Solo via Cloud Functions
      
      // ============================================
      // SUBCOLECCIÓN: players (datos públicos)
      // ============================================
      match /players/{oderId} {
        // Cualquier jugador de la partida puede ver todos los jugadores
        allow read: if isAuthenticated() && isPlayerInGame(gameId);
        
        // Los jugadores pueden actualizar su propio estado de conexión
        allow update: if isAuthenticated() 
                      && oderId == userId()
                      && request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['isConnected']);
        
        // Crear jugadores solo via Cloud Functions (al unirse)
        allow create: if false;
        allow delete: if false;
      }
      
      // ============================================
      // SUBCOLECCIÓN: privateData (roles secretos)
      // ============================================
      match /privateData/{oderId} {
        // CRÍTICO: Solo el propio usuario puede ver su rol secreto
        allow read: if isAuthenticated() && oderId == userId();
        
        // Nadie puede modificar roles desde el cliente
        allow write: if false;
      }
      
      // ============================================
      // SUBCOLECCIÓN: votes (votos de cada ronda)
      // ============================================
      match /votes/{oderId} {
        // Los votos son secretos hasta que todos votan
        // El cliente solo puede ver su propio voto
        allow read: if isAuthenticated() && oderId == userId();
        
        // Solo Cloud Functions gestionan votos
        allow write: if false;
      }
      
      // ============================================
      // SUBCOLECCIÓN: actions (log de acciones)
      // ============================================
      match /actions/{actionId} {
        // Todos los jugadores pueden ver el historial de acciones públicas
        allow read: if isAuthenticated() && isPlayerInGame(gameId);
        
        // Solo Cloud Functions registran acciones
        allow write: if false;
      }
      
      // ============================================
      // SUBCOLECCIÓN: chat (mensajes de chat)
      // ============================================
      match /chat/{messageId} {
        // Jugadores pueden leer mensajes
        allow read: if isAuthenticated() && isPlayerInGame(gameId);
        
        // Jugadores pueden enviar mensajes (validación básica)
        allow create: if isAuthenticated() 
                      && isPlayerInGame(gameId)
                      && request.resource.data.keys().hasAll(['senderId', 'senderName', 'message', 'timestamp'])
                      && request.resource.data.senderId == userId()
                      && request.resource.data.message.size() <= 500;
        
        allow update, delete: if false;
      }
    }
    
    // ============================================
    // COLECCIÓN: users (perfiles de usuario)
    // ============================================
    match /users/{oderId} {
      // Los usuarios pueden leer su propio perfil
      allow read: if isAuthenticated() && oderId == userId();
      
      // Los usuarios pueden actualizar su propio perfil
      allow write: if isAuthenticated() 
                   && oderId == userId()
                   && request.resource.data.keys().hasOnly(['displayName', 'gamesPlayed', 'wins', 'updatedAt']);
    }
  }
}
